**Дизайн-Документ: Генерация Плана v2 - Будущие Улучшения**

**1. Цель**

*   Расширить функциональность генерации плана, построенную в V1, добавив больше интеллектуальных возможностей, улучшенное сохранение деталей и более гибкие инструменты редактирования.

**2. Ключевые Функции (V2)**

1.  **Маркировка и Учет `keyFragments`:**
    *   **UI:** Интерфейс для пользователя, чтобы помечать важные фрагменты (цитаты, ссылки, примеры) внутри `Thoughts`.
    *   **Модель:** Добавление поля `keyFragments` в `Thought`.
    *   **AI:** Обновление промпта `generatePlanPointContent` для *обязательного* включения переданных `keyFragments`.
    *   **Польза:** Гарантированное сохранение критически важных деталей.
2.  **AI-Генерация `OutlinePoints`:**
    *   **UI:** Кнопка "Предложить пункты плана (AI)" на `StructurePage` или `PlanPage` (если пунктов нет).
    *   **API/AI:** Новый endpoint и AI-функция для анализа мыслей секции и предложения структуры (`OutlinePoints`).
    *   **UI:** Интерфейс для просмотра, редактирования и утверждения предложенных AI пунктов.
    *   **Польза:** Помощь пользователям, которые не хотят создавать структуру вручную.
3.  **AI-Редактирование Карточек по Фидбэку:**
    *   **UI:** Кнопка "Уточнить с AI" на карточке, поле для ввода текстового фидбэка.
    *   **API/AI:** Новый endpoint и AI-функция для переписывания контента карточки на основе фидбэка.
    *   **UI:** Отображение предложенного изменения, кнопки "Принять"/"Отклонить".
    *   **Польза:** Быстрая итеративная доработка плана с помощью AI.
4.  **Структурированное Хранение Плана:**
    *   **Модель:** Изменение `Plan` на хранение контента по `outlinePointId`, например: `plan.cards: { [outlinePointId: string]: string }`.
    *   **Бэкэнд:** Обновление логики сохранения и загрузки плана для работы с новой структурой.
    *   **Фронтенд:** Упрощение логики отображения/редактирования (не нужно парсить Markdown).
    *   **Польза:** Более надежное хранение и обновление, упрощение кода.
5.  **Улучшенное Отображение Связанных Мыслей:**
    *   **UI:** Более интерактивный способ просмотра `Thoughts`, связанных с карточкой (например, всплывающее окно, боковая панель).
6.  **(Опционально) AI Помощь с Переходами:**
    *   **UI:** Кнопка между карточками "Добавить переход".
    *   **API/AI:** AI генерирует связующее предложение/абзац между двумя пунктами плана.
7.  **(Опционально) Переупорядочивание Карточек:**
    *   **UI:** Drag-n-Drop для карточек в левой колонке для изменения порядка `OutlinePoints`.
    *   **Логика:** Обновление `sermon.outline` и соответствующее обновление порядка в правой колонке.

**3. Влияние на V1**

*   Потребуется миграция данных `Plan`, если будет изменена модель хранения.
*   API и AI Client будут расширены новыми функциями.
*   UI станет более насыщенным.

**4. Преимущества V2**

*   Еще большее сохранение деталей (`keyFragments`).
*   Снижение ручной работы (AI-генерация `OutlinePoints`, AI-редакция).
*   Более надежное хранение плана.
*   Более мощные инструменты редактирования.

**5. Потенциальные Сложности V2**

*   Точность автоматического извлечения `keyFragments` (если будет).
*   Качество и управляемость AI-редакции по фидбэку.
*   Сложность UI для всех новых функций.